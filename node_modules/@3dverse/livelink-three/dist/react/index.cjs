"use strict";var A=Object.create;var v=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var S=(r,e)=>{for(var t in e)v(r,t,{get:e[t],enumerable:!0})},w=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of M(e))!z.call(r,o)&&o!==t&&v(r,o,{get:()=>e[o],enumerable:!(n=P(e,o))||n.enumerable});return r};var C=(r,e,t)=>(t=r!=null?A(F(r)):{},w(e||!r||!r.__esModule?v(t,"default",{value:r,enumerable:!0}):t,r)),U=r=>w(v({},"__esModule",{value:!0}),r);var N={};S(N,{ThreeOverlay:()=>I,ThreeOverlayContext:()=>g,TransformControls:()=>W,TransformControlsComponent:()=>H});module.exports=U(N);var b=C(require("react")),d=require("react"),x=require("@3dverse/livelink-react");var p=C(require("three")),E=class{#a=new p.Scene;#e;#t;#r;#n;#o=new AbortController;constructor({viewport_camera_projection:e,scene:t}){this.#a=t,this.#t=e.viewport,this.#n=new OffscreenCanvas(this.#t.width,this.#t.height);let n=this.#n.getContext("webgl2");if(!n)throw new Error("Cannot create a WebGL2 context");this.#r=new p.WebGLRenderer({context:n,canvas:this.#n}),this.#r.setClearColor(16777215,0),this.#r.setPixelRatio(1),this.#r.setSize(this.#t.width,this.#t.height,!1),this.#e=this.#s()}get camera(){return this.#e}get scene(){return this.#a}#s(){let e=this.#t.camera_projection?.camera_entity;if(!e)throw new Error("Viewport has no camera_projection");let t=e.perspective_lens,n=e.orthographic_lens;if(this.#o.abort(),this.#o=new AbortController,t)this.#e=this.#i({cameraEntity:e,perspective_lens:t});else if(n)this.#e=this.#l({cameraEntity:e,orthographic_lens:n});else throw new Error("Camera entity has no perspective_lens or orthographic_lens component");return this.#e.matrixAutoUpdate=!1,this.#e}#i({cameraEntity:e,perspective_lens:t}){let n=new p.PerspectiveCamera,o=1e5,c=l=>{n.aspect=this.#t.aspect_ratio,n.fov=l.fovy,n.near=l.nearPlane,n.far=l.farPlane||o},a=l=>{if(l.deleted_components.includes("perspective_lens")){this.#s();return}l.updated_components.includes("perspective_lens")&&c(e.perspective_lens)};return e.addEventListener("on-entity-updated",a,{signal:this.#o.signal}),c(t),n}#l({cameraEntity:e,orthographic_lens:t}){let n=new p.OrthographicCamera,o=a=>{n.left=-this.#t.aspect_ratio*a.zoomFactor[0],n.right=this.#t.aspect_ratio*a.zoomFactor[0],n.top=-a.zoomFactor[1],n.bottom=a.zoomFactor[1],n.near=a.zNear,n.far=a.zFar},c=a=>{if(a.deleted_components.includes("orthographic_lens")){this.#s();return}a.updated_components.includes("orthographic_lens")&&o(e.orthographic_lens)};return e.addEventListener("on-entity-updated",c,{signal:this.#o.signal}),o(t),n}draw({output_canvas:e}){let t=this.#t.camera_projection;if(!t)return null;if(this.#c({viewport_camera_projection:t}),e)throw new Error("Not implemented");return this.#n}#c({viewport_camera_projection:e}){this.#e.position.fromArray(e.world_position),this.#e.quaternion.fromArray(e.world_orientation),this.#e.updateMatrix(),this.#e.projectionMatrix.fromArray(e.clip_from_view_matrix),this.#e.projectionMatrixInverse.fromArray(e.view_from_clip_matrix),this.#r.setViewport(0,0,this.#t.width,this.#t.height),this.#r.render(this.#a,this.#e)}resize({width:e,height:t}){this.#n.width=e,this.#n.height=t,this.#r.setSize(e,t,!1)}release(){this.#o.abort(),this.#r.dispose()}};var g=(0,d.createContext)({overlay:null});function I({scene:r,children:e}){let{viewport:t,camera:n}=(0,d.useContext)(x.ViewportContext),[o,c]=(0,d.useState)(null);return(0,d.useEffect)(()=>{if(!t||!n){c(null);return}let a=new E({viewport_camera_projection:n,scene:r});return t.addOverlay({overlay:a}),c(a),()=>{t.removeOverlay({overlay:a})}},[t,n]),b.default.createElement(g.Provider,{value:{overlay:o}},e)}var i=require("react"),R=C(require("three")),L=require("@3dverse/livelink-react");function H({controlledEntity:r,cameraController:e,setDragging:t},n){let{overlay:o}=(0,i.useContext)(g),{viewport:c}=(0,i.useContext)(L.ViewportContext),a=V(),l=(0,i.useMemo)(()=>new R.Object3D,[]),[s,O]=(0,i.useState)(void 0);return(0,i.useImperativeHandle)(n,()=>s,[s]),(0,i.useEffect)(()=>{if(!c||!o||!e||!a)return;let m=new a.TransformControls(o.camera,c.dom_element),f=function(){c.rendering_surface.redrawLastFrame()};return c.dom_element.addEventListener("pointermove",f),O(m),o.scene.add(m.getHelper()),()=>{c.dom_element.removeEventListener("pointermove",f),o.scene.remove(m.getHelper()),m.dispose()}},[c,o,e,a]),(0,i.useEffect)(()=>{if(!s||!e)return;let m=function(f){let h=!!f.value;e.enabled=!h,t&&setTimeout(()=>t(h),0)};return s.addEventListener("dragging-changed",m),()=>{s.removeEventListener("dragging-changed",m)}},[s,e,t]),(0,i.useEffect)(()=>{if(!r||!s||!o)return;o.scene.add(l),s.attach(l);let m=!1,f=function(){r.global_transform.position=s.object.position.toArray(),s.object.quaternion.toArray(r.global_transform.orientation),r.global_transform={scale:s.object.scale.toArray()}},h=function(y){m=!!y.value};s.addEventListener("dragging-changed",h);let j=function(y){y.updated_components.includes("local_transform")&&!m&&T()},T=function(){l.position.fromArray(r.global_transform.position),l.quaternion.fromArray(r.global_transform.orientation),l.scale.fromArray(r.global_transform.scale),l.updateMatrixWorld()};s.addEventListener("objectChange",f);let _=new AbortController,u=r;for(;u;)u.addEventListener("on-entity-updated",j,{signal:_.signal}),u=u.parent;return T(),()=>{o.scene.remove(l),s.removeEventListener("objectChange",f),s.removeEventListener("dragging-changed",h),_.abort(),s.detach()}},[o,r,s,l]),null}var V=()=>{let[r,e]=(0,i.useState)(void 0);return(0,i.useEffect)(()=>{import("three/addons/controls/TransformControls.js").then(e)},[]),r},W=(0,i.forwardRef)(H);
//# sourceMappingURL=index.cjs.map
