"use strict";var m=Object.create;var h=Object.defineProperty;var d=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var u=(n,e)=>{for(var t in e)h(n,t,{get:e[t],enumerable:!0})},l=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of f(e))!_.call(n,s)&&s!==t&&h(n,s,{get:()=>e[s],enumerable:!(r=d(e,s))||r.enumerable});return n};var v=(n,e,t)=>(t=n!=null?m(E(n)):{},l(e||!n||!n.__esModule?h(t,"default",{value:n,enumerable:!0}):t,n)),w=n=>l(h({},"__esModule",{value:!0}),n);var C={};u(C,{ThreeOverlay:()=>p});module.exports=w(C);var o=v(require("three")),p=class{#s=new o.Scene;#e;#t;#r;#n;#i=new AbortController;constructor({viewport_camera_projection:e,scene:t}){this.#s=t,this.#t=e.viewport,this.#n=new OffscreenCanvas(this.#t.width,this.#t.height);let r=this.#n.getContext("webgl2");if(!r)throw new Error("Cannot create a WebGL2 context");this.#r=new o.WebGLRenderer({context:r,canvas:this.#n}),this.#r.setClearColor(16777215,0),this.#r.setPixelRatio(1),this.#r.setSize(this.#t.width,this.#t.height,!1),this.#e=this.#o()}get camera(){return this.#e}get scene(){return this.#s}#o(){let e=this.#t.camera_projection?.camera_entity;if(!e)throw new Error("Viewport has no camera_projection");let t=e.perspective_lens,r=e.orthographic_lens;if(this.#i.abort(),this.#i=new AbortController,t)this.#e=this.#a({cameraEntity:e,perspective_lens:t});else if(r)this.#e=this.#c({cameraEntity:e,orthographic_lens:r});else throw new Error("Camera entity has no perspective_lens or orthographic_lens component");return this.#e.matrixAutoUpdate=!1,this.#e}#a({cameraEntity:e,perspective_lens:t}){let r=new o.PerspectiveCamera,s=1e5,c=a=>{r.aspect=this.#t.aspect_ratio,r.fov=a.fovy,r.near=a.nearPlane,r.far=a.farPlane||s},i=a=>{if(a.deleted_components.includes("perspective_lens")){this.#o();return}a.updated_components.includes("perspective_lens")&&c(e.perspective_lens)};return e.addEventListener("on-entity-updated",i,{signal:this.#i.signal}),c(t),r}#c({cameraEntity:e,orthographic_lens:t}){let r=new o.OrthographicCamera,s=i=>{r.left=-this.#t.aspect_ratio*i.zoomFactor[0],r.right=this.#t.aspect_ratio*i.zoomFactor[0],r.top=-i.zoomFactor[1],r.bottom=i.zoomFactor[1],r.near=i.zNear,r.far=i.zFar},c=i=>{if(i.deleted_components.includes("orthographic_lens")){this.#o();return}i.updated_components.includes("orthographic_lens")&&s(e.orthographic_lens)};return e.addEventListener("on-entity-updated",c,{signal:this.#i.signal}),s(t),r}draw({output_canvas:e}){let t=this.#t.camera_projection;if(!t)return null;if(this.#h({viewport_camera_projection:t}),e)throw new Error("Not implemented");return this.#n}#h({viewport_camera_projection:e}){this.#e.position.fromArray(e.world_position),this.#e.quaternion.fromArray(e.world_orientation),this.#e.updateMatrix(),this.#e.projectionMatrix.fromArray(e.clip_from_view_matrix),this.#e.projectionMatrixInverse.fromArray(e.view_from_clip_matrix),this.#r.setViewport(0,0,this.#t.width,this.#t.height),this.#r.render(this.#s,this.#e)}resize({width:e,height:t}){this.#n.width=e,this.#n.height=t,this.#r.setSize(e,t,!1)}release(){this.#i.abort(),this.#r.dispose()}};
//# sourceMappingURL=index.cjs.map
