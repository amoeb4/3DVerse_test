"use strict";var ee=Object.create;var j=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var W=(r,e)=>{for(var n in e)j(r,n,{get:e[n],enumerable:!0})},sr=(r,e,n,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ae(e))!te.call(r,i)&&i!==n&&j(r,i,{get:()=>e[i],enumerable:!(a=ne(e,i))||a.enumerable});return r};var se=(r,e,n)=>(n=r!=null?ee(ie(r)):{},sr(e||!r||!r.__esModule?j(n,"default",{value:r,enumerable:!0}):n,r)),ce=r=>sr(j({},"__esModule",{value:!0}),r);var Qa={};W(Qa,{WebXR:()=>$a,WebXRContext:()=>re,WebXRHelper:()=>H});module.exports=ce(Qa);var C=require("@3dverse/livelink");var R=1e-6,P=typeof Float32Array<"u"?Float32Array:Array,q=Math.random;var Za=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});function cr(){var r=new P(9);return P!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}var U={};W(U,{add:()=>He,adjoint:()=>me,clone:()=>he,copy:()=>fe,create:()=>le,determinant:()=>de,equals:()=>Ke,exactEquals:()=>Qe,frob:()=>Be,fromQuat:()=>Ne,fromQuat2:()=>ze,fromRotation:()=>Pe,fromRotationTranslation:()=>hr,fromRotationTranslationScale:()=>Oe,fromRotationTranslationScaleOrigin:()=>Fe,fromScaling:()=>Se,fromTranslation:()=>Ee,fromValues:()=>oe,fromXRotation:()=>be,fromYRotation:()=>Le,fromZRotation:()=>Te,frustum:()=>Ve,getRotation:()=>Xe,getScaling:()=>fr,getTranslation:()=>Ie,identity:()=>vr,invert:()=>Me,lookAt:()=>We,mul:()=>Ze,multiply:()=>lr,multiplyScalar:()=>je,multiplyScalarAndAdd:()=>$e,ortho:()=>ke,orthoNO:()=>pr,orthoZO:()=>De,perspective:()=>qe,perspectiveFromFieldOfView:()=>Ye,perspectiveNO:()=>or,perspectiveZO:()=>Ce,rotate:()=>ye,rotateX:()=>we,rotateY:()=>Re,rotateZ:()=>Ae,scale:()=>_e,set:()=>pe,str:()=>Ge,sub:()=>Je,subtract:()=>xr,targetTo:()=>Ue,translate:()=>ge,transpose:()=>xe});function le(){var r=new P(16);return P!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function he(r){var e=new P(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function fe(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function oe(r,e,n,a,i,t,s,c,v,l,h,f,x,p,m,M){var o=new P(16);return o[0]=r,o[1]=e,o[2]=n,o[3]=a,o[4]=i,o[5]=t,o[6]=s,o[7]=c,o[8]=v,o[9]=l,o[10]=h,o[11]=f,o[12]=x,o[13]=p,o[14]=m,o[15]=M,o}function pe(r,e,n,a,i,t,s,c,v,l,h,f,x,p,m,M,o){return r[0]=e,r[1]=n,r[2]=a,r[3]=i,r[4]=t,r[5]=s,r[6]=c,r[7]=v,r[8]=l,r[9]=h,r[10]=f,r[11]=x,r[12]=p,r[13]=m,r[14]=M,r[15]=o,r}function vr(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function xe(r,e){if(r===e){var n=e[1],a=e[2],i=e[3],t=e[6],s=e[7],c=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=n,r[6]=e[9],r[7]=e[13],r[8]=a,r[9]=t,r[11]=e[14],r[12]=i,r[13]=s,r[14]=c}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r}function Me(r,e){var n=e[0],a=e[1],i=e[2],t=e[3],s=e[4],c=e[5],v=e[6],l=e[7],h=e[8],f=e[9],x=e[10],p=e[11],m=e[12],M=e[13],o=e[14],d=e[15],A=n*c-a*s,w=n*v-i*s,g=n*l-t*s,_=a*v-i*c,y=a*l-t*c,S=i*l-t*v,b=h*M-f*m,L=h*o-x*m,T=h*d-p*m,I=f*o-x*M,X=f*d-p*M,O=x*d-p*o,E=A*O-w*X+g*I+_*T-y*L+S*b;return E?(E=1/E,r[0]=(c*O-v*X+l*I)*E,r[1]=(i*X-a*O-t*I)*E,r[2]=(M*S-o*y+d*_)*E,r[3]=(x*y-f*S-p*_)*E,r[4]=(v*T-s*O-l*L)*E,r[5]=(n*O-i*T+t*L)*E,r[6]=(o*g-m*S-d*w)*E,r[7]=(h*S-x*g+p*w)*E,r[8]=(s*X-c*T+l*b)*E,r[9]=(a*T-n*X-t*b)*E,r[10]=(m*y-M*g+d*A)*E,r[11]=(f*g-h*y-p*A)*E,r[12]=(c*L-s*I-v*b)*E,r[13]=(n*I-a*L+i*b)*E,r[14]=(M*w-m*_-o*A)*E,r[15]=(h*_-f*w+x*A)*E,r):null}function me(r,e){var n=e[0],a=e[1],i=e[2],t=e[3],s=e[4],c=e[5],v=e[6],l=e[7],h=e[8],f=e[9],x=e[10],p=e[11],m=e[12],M=e[13],o=e[14],d=e[15];return r[0]=c*(x*d-p*o)-f*(v*d-l*o)+M*(v*p-l*x),r[1]=-(a*(x*d-p*o)-f*(i*d-t*o)+M*(i*p-t*x)),r[2]=a*(v*d-l*o)-c*(i*d-t*o)+M*(i*l-t*v),r[3]=-(a*(v*p-l*x)-c*(i*p-t*x)+f*(i*l-t*v)),r[4]=-(s*(x*d-p*o)-h*(v*d-l*o)+m*(v*p-l*x)),r[5]=n*(x*d-p*o)-h*(i*d-t*o)+m*(i*p-t*x),r[6]=-(n*(v*d-l*o)-s*(i*d-t*o)+m*(i*l-t*v)),r[7]=n*(v*p-l*x)-s*(i*p-t*x)+h*(i*l-t*v),r[8]=s*(f*d-p*M)-h*(c*d-l*M)+m*(c*p-l*f),r[9]=-(n*(f*d-p*M)-h*(a*d-t*M)+m*(a*p-t*f)),r[10]=n*(c*d-l*M)-s*(a*d-t*M)+m*(a*l-t*c),r[11]=-(n*(c*p-l*f)-s*(a*p-t*f)+h*(a*l-t*c)),r[12]=-(s*(f*o-x*M)-h*(c*o-v*M)+m*(c*x-v*f)),r[13]=n*(f*o-x*M)-h*(a*o-i*M)+m*(a*x-i*f),r[14]=-(n*(c*o-v*M)-s*(a*o-i*M)+m*(a*v-i*c)),r[15]=n*(c*x-v*f)-s*(a*x-i*f)+h*(a*v-i*c),r}function de(r){var e=r[0],n=r[1],a=r[2],i=r[3],t=r[4],s=r[5],c=r[6],v=r[7],l=r[8],h=r[9],f=r[10],x=r[11],p=r[12],m=r[13],M=r[14],o=r[15],d=e*s-n*t,A=e*c-a*t,w=e*v-i*t,g=n*c-a*s,_=n*v-i*s,y=a*v-i*c,S=l*m-h*p,b=l*M-f*p,L=l*o-x*p,T=h*M-f*m,I=h*o-x*m,X=f*o-x*M;return d*X-A*I+w*T+g*L-_*b+y*S}function lr(r,e,n){var a=e[0],i=e[1],t=e[2],s=e[3],c=e[4],v=e[5],l=e[6],h=e[7],f=e[8],x=e[9],p=e[10],m=e[11],M=e[12],o=e[13],d=e[14],A=e[15],w=n[0],g=n[1],_=n[2],y=n[3];return r[0]=w*a+g*c+_*f+y*M,r[1]=w*i+g*v+_*x+y*o,r[2]=w*t+g*l+_*p+y*d,r[3]=w*s+g*h+_*m+y*A,w=n[4],g=n[5],_=n[6],y=n[7],r[4]=w*a+g*c+_*f+y*M,r[5]=w*i+g*v+_*x+y*o,r[6]=w*t+g*l+_*p+y*d,r[7]=w*s+g*h+_*m+y*A,w=n[8],g=n[9],_=n[10],y=n[11],r[8]=w*a+g*c+_*f+y*M,r[9]=w*i+g*v+_*x+y*o,r[10]=w*t+g*l+_*p+y*d,r[11]=w*s+g*h+_*m+y*A,w=n[12],g=n[13],_=n[14],y=n[15],r[12]=w*a+g*c+_*f+y*M,r[13]=w*i+g*v+_*x+y*o,r[14]=w*t+g*l+_*p+y*d,r[15]=w*s+g*h+_*m+y*A,r}function ge(r,e,n){var a=n[0],i=n[1],t=n[2],s,c,v,l,h,f,x,p,m,M,o,d;return e===r?(r[12]=e[0]*a+e[4]*i+e[8]*t+e[12],r[13]=e[1]*a+e[5]*i+e[9]*t+e[13],r[14]=e[2]*a+e[6]*i+e[10]*t+e[14],r[15]=e[3]*a+e[7]*i+e[11]*t+e[15]):(s=e[0],c=e[1],v=e[2],l=e[3],h=e[4],f=e[5],x=e[6],p=e[7],m=e[8],M=e[9],o=e[10],d=e[11],r[0]=s,r[1]=c,r[2]=v,r[3]=l,r[4]=h,r[5]=f,r[6]=x,r[7]=p,r[8]=m,r[9]=M,r[10]=o,r[11]=d,r[12]=s*a+h*i+m*t+e[12],r[13]=c*a+f*i+M*t+e[13],r[14]=v*a+x*i+o*t+e[14],r[15]=l*a+p*i+d*t+e[15]),r}function _e(r,e,n){var a=n[0],i=n[1],t=n[2];return r[0]=e[0]*a,r[1]=e[1]*a,r[2]=e[2]*a,r[3]=e[3]*a,r[4]=e[4]*i,r[5]=e[5]*i,r[6]=e[6]*i,r[7]=e[7]*i,r[8]=e[8]*t,r[9]=e[9]*t,r[10]=e[10]*t,r[11]=e[11]*t,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function ye(r,e,n,a){var i=a[0],t=a[1],s=a[2],c=Math.hypot(i,t,s),v,l,h,f,x,p,m,M,o,d,A,w,g,_,y,S,b,L,T,I,X,O,E,V;return c<R?null:(c=1/c,i*=c,t*=c,s*=c,v=Math.sin(n),l=Math.cos(n),h=1-l,f=e[0],x=e[1],p=e[2],m=e[3],M=e[4],o=e[5],d=e[6],A=e[7],w=e[8],g=e[9],_=e[10],y=e[11],S=i*i*h+l,b=t*i*h+s*v,L=s*i*h-t*v,T=i*t*h-s*v,I=t*t*h+l,X=s*t*h+i*v,O=i*s*h+t*v,E=t*s*h-i*v,V=s*s*h+l,r[0]=f*S+M*b+w*L,r[1]=x*S+o*b+g*L,r[2]=p*S+d*b+_*L,r[3]=m*S+A*b+y*L,r[4]=f*T+M*I+w*X,r[5]=x*T+o*I+g*X,r[6]=p*T+d*I+_*X,r[7]=m*T+A*I+y*X,r[8]=f*O+M*E+w*V,r[9]=x*O+o*E+g*V,r[10]=p*O+d*E+_*V,r[11]=m*O+A*E+y*V,e!==r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r)}function we(r,e,n){var a=Math.sin(n),i=Math.cos(n),t=e[4],s=e[5],c=e[6],v=e[7],l=e[8],h=e[9],f=e[10],x=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=t*i+l*a,r[5]=s*i+h*a,r[6]=c*i+f*a,r[7]=v*i+x*a,r[8]=l*i-t*a,r[9]=h*i-s*a,r[10]=f*i-c*a,r[11]=x*i-v*a,r}function Re(r,e,n){var a=Math.sin(n),i=Math.cos(n),t=e[0],s=e[1],c=e[2],v=e[3],l=e[8],h=e[9],f=e[10],x=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=t*i-l*a,r[1]=s*i-h*a,r[2]=c*i-f*a,r[3]=v*i-x*a,r[8]=t*a+l*i,r[9]=s*a+h*i,r[10]=c*a+f*i,r[11]=v*a+x*i,r}function Ae(r,e,n){var a=Math.sin(n),i=Math.cos(n),t=e[0],s=e[1],c=e[2],v=e[3],l=e[4],h=e[5],f=e[6],x=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=t*i+l*a,r[1]=s*i+h*a,r[2]=c*i+f*a,r[3]=v*i+x*a,r[4]=l*i-t*a,r[5]=h*i-s*a,r[6]=f*i-c*a,r[7]=x*i-v*a,r}function Ee(r,e){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function Se(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Pe(r,e,n){var a=n[0],i=n[1],t=n[2],s=Math.hypot(a,i,t),c,v,l;return s<R?null:(s=1/s,a*=s,i*=s,t*=s,c=Math.sin(e),v=Math.cos(e),l=1-v,r[0]=a*a*l+v,r[1]=i*a*l+t*c,r[2]=t*a*l-i*c,r[3]=0,r[4]=a*i*l-t*c,r[5]=i*i*l+v,r[6]=t*i*l+a*c,r[7]=0,r[8]=a*t*l+i*c,r[9]=i*t*l-a*c,r[10]=t*t*l+v,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function be(r,e){var n=Math.sin(e),a=Math.cos(e);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=a,r[6]=n,r[7]=0,r[8]=0,r[9]=-n,r[10]=a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Le(r,e){var n=Math.sin(e),a=Math.cos(e);return r[0]=a,r[1]=0,r[2]=-n,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=n,r[9]=0,r[10]=a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Te(r,e){var n=Math.sin(e),a=Math.cos(e);return r[0]=a,r[1]=n,r[2]=0,r[3]=0,r[4]=-n,r[5]=a,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function hr(r,e,n){var a=e[0],i=e[1],t=e[2],s=e[3],c=a+a,v=i+i,l=t+t,h=a*c,f=a*v,x=a*l,p=i*v,m=i*l,M=t*l,o=s*c,d=s*v,A=s*l;return r[0]=1-(p+M),r[1]=f+A,r[2]=x-d,r[3]=0,r[4]=f-A,r[5]=1-(h+M),r[6]=m+o,r[7]=0,r[8]=x+d,r[9]=m-o,r[10]=1-(h+p),r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function ze(r,e){var n=new P(3),a=-e[0],i=-e[1],t=-e[2],s=e[3],c=e[4],v=e[5],l=e[6],h=e[7],f=a*a+i*i+t*t+s*s;return f>0?(n[0]=(c*s+h*a+v*t-l*i)*2/f,n[1]=(v*s+h*i+l*a-c*t)*2/f,n[2]=(l*s+h*t+c*i-v*a)*2/f):(n[0]=(c*s+h*a+v*t-l*i)*2,n[1]=(v*s+h*i+l*a-c*t)*2,n[2]=(l*s+h*t+c*i-v*a)*2),hr(r,e,n),r}function Ie(r,e){return r[0]=e[12],r[1]=e[13],r[2]=e[14],r}function fr(r,e){var n=e[0],a=e[1],i=e[2],t=e[4],s=e[5],c=e[6],v=e[8],l=e[9],h=e[10];return r[0]=Math.hypot(n,a,i),r[1]=Math.hypot(t,s,c),r[2]=Math.hypot(v,l,h),r}function Xe(r,e){var n=new P(3);fr(n,e);var a=1/n[0],i=1/n[1],t=1/n[2],s=e[0]*a,c=e[1]*i,v=e[2]*t,l=e[4]*a,h=e[5]*i,f=e[6]*t,x=e[8]*a,p=e[9]*i,m=e[10]*t,M=s+h+m,o=0;return M>0?(o=Math.sqrt(M+1)*2,r[3]=.25*o,r[0]=(f-p)/o,r[1]=(x-v)/o,r[2]=(c-l)/o):s>h&&s>m?(o=Math.sqrt(1+s-h-m)*2,r[3]=(f-p)/o,r[0]=.25*o,r[1]=(c+l)/o,r[2]=(x+v)/o):h>m?(o=Math.sqrt(1+h-s-m)*2,r[3]=(x-v)/o,r[0]=(c+l)/o,r[1]=.25*o,r[2]=(f+p)/o):(o=Math.sqrt(1+m-s-h)*2,r[3]=(c-l)/o,r[0]=(x+v)/o,r[1]=(f+p)/o,r[2]=.25*o),r}function Oe(r,e,n,a){var i=e[0],t=e[1],s=e[2],c=e[3],v=i+i,l=t+t,h=s+s,f=i*v,x=i*l,p=i*h,m=t*l,M=t*h,o=s*h,d=c*v,A=c*l,w=c*h,g=a[0],_=a[1],y=a[2];return r[0]=(1-(m+o))*g,r[1]=(x+w)*g,r[2]=(p-A)*g,r[3]=0,r[4]=(x-w)*_,r[5]=(1-(f+o))*_,r[6]=(M+d)*_,r[7]=0,r[8]=(p+A)*y,r[9]=(M-d)*y,r[10]=(1-(f+m))*y,r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function Fe(r,e,n,a,i){var t=e[0],s=e[1],c=e[2],v=e[3],l=t+t,h=s+s,f=c+c,x=t*l,p=t*h,m=t*f,M=s*h,o=s*f,d=c*f,A=v*l,w=v*h,g=v*f,_=a[0],y=a[1],S=a[2],b=i[0],L=i[1],T=i[2],I=(1-(M+d))*_,X=(p+g)*_,O=(m-w)*_,E=(p-g)*y,V=(1-(x+d))*y,k=(o+A)*y,D=(m+w)*S,ir=(o-A)*S,tr=(1-(x+M))*S;return r[0]=I,r[1]=X,r[2]=O,r[3]=0,r[4]=E,r[5]=V,r[6]=k,r[7]=0,r[8]=D,r[9]=ir,r[10]=tr,r[11]=0,r[12]=n[0]+b-(I*b+E*L+D*T),r[13]=n[1]+L-(X*b+V*L+ir*T),r[14]=n[2]+T-(O*b+k*L+tr*T),r[15]=1,r}function Ne(r,e){var n=e[0],a=e[1],i=e[2],t=e[3],s=n+n,c=a+a,v=i+i,l=n*s,h=a*s,f=a*c,x=i*s,p=i*c,m=i*v,M=t*s,o=t*c,d=t*v;return r[0]=1-f-m,r[1]=h+d,r[2]=x-o,r[3]=0,r[4]=h-d,r[5]=1-l-m,r[6]=p+M,r[7]=0,r[8]=x+o,r[9]=p-M,r[10]=1-l-f,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ve(r,e,n,a,i,t,s){var c=1/(n-e),v=1/(i-a),l=1/(t-s);return r[0]=t*2*c,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t*2*v,r[6]=0,r[7]=0,r[8]=(n+e)*c,r[9]=(i+a)*v,r[10]=(s+t)*l,r[11]=-1,r[12]=0,r[13]=0,r[14]=s*t*2*l,r[15]=0,r}function or(r,e,n,a,i){var t=1/Math.tan(e/2),s;return r[0]=t/n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,i!=null&&i!==1/0?(s=1/(a-i),r[10]=(i+a)*s,r[14]=2*i*a*s):(r[10]=-1,r[14]=-2*a),r}var qe=or;function Ce(r,e,n,a,i){var t=1/Math.tan(e/2),s;return r[0]=t/n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,i!=null&&i!==1/0?(s=1/(a-i),r[10]=i*s,r[14]=i*a*s):(r[10]=-1,r[14]=-a),r}function Ye(r,e,n,a){var i=Math.tan(e.upDegrees*Math.PI/180),t=Math.tan(e.downDegrees*Math.PI/180),s=Math.tan(e.leftDegrees*Math.PI/180),c=Math.tan(e.rightDegrees*Math.PI/180),v=2/(s+c),l=2/(i+t);return r[0]=v,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=l,r[6]=0,r[7]=0,r[8]=-((s-c)*v*.5),r[9]=(i-t)*l*.5,r[10]=a/(n-a),r[11]=-1,r[12]=0,r[13]=0,r[14]=a*n/(n-a),r[15]=0,r}function pr(r,e,n,a,i,t,s){var c=1/(e-n),v=1/(a-i),l=1/(t-s);return r[0]=-2*c,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*v,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*l,r[11]=0,r[12]=(e+n)*c,r[13]=(i+a)*v,r[14]=(s+t)*l,r[15]=1,r}var ke=pr;function De(r,e,n,a,i,t,s){var c=1/(e-n),v=1/(a-i),l=1/(t-s);return r[0]=-2*c,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*v,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=l,r[11]=0,r[12]=(e+n)*c,r[13]=(i+a)*v,r[14]=t*l,r[15]=1,r}function We(r,e,n,a){var i,t,s,c,v,l,h,f,x,p,m=e[0],M=e[1],o=e[2],d=a[0],A=a[1],w=a[2],g=n[0],_=n[1],y=n[2];return Math.abs(m-g)<R&&Math.abs(M-_)<R&&Math.abs(o-y)<R?vr(r):(h=m-g,f=M-_,x=o-y,p=1/Math.hypot(h,f,x),h*=p,f*=p,x*=p,i=A*x-w*f,t=w*h-d*x,s=d*f-A*h,p=Math.hypot(i,t,s),p?(p=1/p,i*=p,t*=p,s*=p):(i=0,t=0,s=0),c=f*s-x*t,v=x*i-h*s,l=h*t-f*i,p=Math.hypot(c,v,l),p?(p=1/p,c*=p,v*=p,l*=p):(c=0,v=0,l=0),r[0]=i,r[1]=c,r[2]=h,r[3]=0,r[4]=t,r[5]=v,r[6]=f,r[7]=0,r[8]=s,r[9]=l,r[10]=x,r[11]=0,r[12]=-(i*m+t*M+s*o),r[13]=-(c*m+v*M+l*o),r[14]=-(h*m+f*M+x*o),r[15]=1,r)}function Ue(r,e,n,a){var i=e[0],t=e[1],s=e[2],c=a[0],v=a[1],l=a[2],h=i-n[0],f=t-n[1],x=s-n[2],p=h*h+f*f+x*x;p>0&&(p=1/Math.sqrt(p),h*=p,f*=p,x*=p);var m=v*x-l*f,M=l*h-c*x,o=c*f-v*h;return p=m*m+M*M+o*o,p>0&&(p=1/Math.sqrt(p),m*=p,M*=p,o*=p),r[0]=m,r[1]=M,r[2]=o,r[3]=0,r[4]=f*o-x*M,r[5]=x*m-h*o,r[6]=h*M-f*m,r[7]=0,r[8]=h,r[9]=f,r[10]=x,r[11]=0,r[12]=i,r[13]=t,r[14]=s,r[15]=1,r}function Ge(r){return"mat4("+r[0]+", "+r[1]+", "+r[2]+", "+r[3]+", "+r[4]+", "+r[5]+", "+r[6]+", "+r[7]+", "+r[8]+", "+r[9]+", "+r[10]+", "+r[11]+", "+r[12]+", "+r[13]+", "+r[14]+", "+r[15]+")"}function Be(r){return Math.hypot(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15])}function He(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r[2]=e[2]+n[2],r[3]=e[3]+n[3],r[4]=e[4]+n[4],r[5]=e[5]+n[5],r[6]=e[6]+n[6],r[7]=e[7]+n[7],r[8]=e[8]+n[8],r[9]=e[9]+n[9],r[10]=e[10]+n[10],r[11]=e[11]+n[11],r[12]=e[12]+n[12],r[13]=e[13]+n[13],r[14]=e[14]+n[14],r[15]=e[15]+n[15],r}function xr(r,e,n){return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],r[3]=e[3]-n[3],r[4]=e[4]-n[4],r[5]=e[5]-n[5],r[6]=e[6]-n[6],r[7]=e[7]-n[7],r[8]=e[8]-n[8],r[9]=e[9]-n[9],r[10]=e[10]-n[10],r[11]=e[11]-n[11],r[12]=e[12]-n[12],r[13]=e[13]-n[13],r[14]=e[14]-n[14],r[15]=e[15]-n[15],r}function je(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r[3]=e[3]*n,r[4]=e[4]*n,r[5]=e[5]*n,r[6]=e[6]*n,r[7]=e[7]*n,r[8]=e[8]*n,r[9]=e[9]*n,r[10]=e[10]*n,r[11]=e[11]*n,r[12]=e[12]*n,r[13]=e[13]*n,r[14]=e[14]*n,r[15]=e[15]*n,r}function $e(r,e,n,a){return r[0]=e[0]+n[0]*a,r[1]=e[1]+n[1]*a,r[2]=e[2]+n[2]*a,r[3]=e[3]+n[3]*a,r[4]=e[4]+n[4]*a,r[5]=e[5]+n[5]*a,r[6]=e[6]+n[6]*a,r[7]=e[7]+n[7]*a,r[8]=e[8]+n[8]*a,r[9]=e[9]+n[9]*a,r[10]=e[10]+n[10]*a,r[11]=e[11]+n[11]*a,r[12]=e[12]+n[12]*a,r[13]=e[13]+n[13]*a,r[14]=e[14]+n[14]*a,r[15]=e[15]+n[15]*a,r}function Qe(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]&&r[4]===e[4]&&r[5]===e[5]&&r[6]===e[6]&&r[7]===e[7]&&r[8]===e[8]&&r[9]===e[9]&&r[10]===e[10]&&r[11]===e[11]&&r[12]===e[12]&&r[13]===e[13]&&r[14]===e[14]&&r[15]===e[15]}function Ke(r,e){var n=r[0],a=r[1],i=r[2],t=r[3],s=r[4],c=r[5],v=r[6],l=r[7],h=r[8],f=r[9],x=r[10],p=r[11],m=r[12],M=r[13],o=r[14],d=r[15],A=e[0],w=e[1],g=e[2],_=e[3],y=e[4],S=e[5],b=e[6],L=e[7],T=e[8],I=e[9],X=e[10],O=e[11],E=e[12],V=e[13],k=e[14],D=e[15];return Math.abs(n-A)<=R*Math.max(1,Math.abs(n),Math.abs(A))&&Math.abs(a-w)<=R*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(i-g)<=R*Math.max(1,Math.abs(i),Math.abs(g))&&Math.abs(t-_)<=R*Math.max(1,Math.abs(t),Math.abs(_))&&Math.abs(s-y)<=R*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(c-S)<=R*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(v-b)<=R*Math.max(1,Math.abs(v),Math.abs(b))&&Math.abs(l-L)<=R*Math.max(1,Math.abs(l),Math.abs(L))&&Math.abs(h-T)<=R*Math.max(1,Math.abs(h),Math.abs(T))&&Math.abs(f-I)<=R*Math.max(1,Math.abs(f),Math.abs(I))&&Math.abs(x-X)<=R*Math.max(1,Math.abs(x),Math.abs(X))&&Math.abs(p-O)<=R*Math.max(1,Math.abs(p),Math.abs(O))&&Math.abs(m-E)<=R*Math.max(1,Math.abs(m),Math.abs(E))&&Math.abs(M-V)<=R*Math.max(1,Math.abs(M),Math.abs(V))&&Math.abs(o-k)<=R*Math.max(1,Math.abs(o),Math.abs(k))&&Math.abs(d-D)<=R*Math.max(1,Math.abs(d),Math.abs(D))}var Ze=lr,Je=xr;var B={};W(B,{add:()=>ra,calculateW:()=>Un,clone:()=>Kn,conjugate:()=>jn,copy:()=>Jn,create:()=>nr,dot:()=>Dr,equals:()=>sa,exactEquals:()=>ta,exp:()=>qr,fromEuler:()=>$n,fromMat3:()=>Yr,fromValues:()=>Zn,getAngle:()=>Yn,getAxisAngle:()=>Cn,identity:()=>qn,invert:()=>Hn,len:()=>aa,length:()=>Wr,lerp:()=>na,ln:()=>Cr,mul:()=>ea,multiply:()=>Vr,normalize:()=>ar,pow:()=>Gn,random:()=>Bn,rotateX:()=>kn,rotateY:()=>Dn,rotateZ:()=>Wn,rotationTo:()=>ca,scale:()=>kr,set:()=>un,setAxes:()=>la,setAxisAngle:()=>Nr,slerp:()=>Z,sqlerp:()=>va,sqrLen:()=>ia,squaredLength:()=>Ur,str:()=>Qn});var N={};W(N,{add:()=>nn,angle:()=>An,bezier:()=>Mn,ceil:()=>an,clone:()=>ue,copy:()=>rn,create:()=>$,cross:()=>G,dist:()=>In,distance:()=>_r,div:()=>zn,divide:()=>gr,dot:()=>K,equals:()=>bn,exactEquals:()=>Pn,floor:()=>tn,forEach:()=>Fn,fromValues:()=>Q,hermite:()=>xn,inverse:()=>on,len:()=>er,length:()=>Mr,lerp:()=>pn,max:()=>cn,min:()=>sn,mul:()=>Tn,multiply:()=>dr,negate:()=>fn,normalize:()=>rr,random:()=>mn,rotateX:()=>yn,rotateY:()=>wn,rotateZ:()=>Rn,round:()=>vn,scale:()=>ln,scaleAndAdd:()=>hn,set:()=>en,sqrDist:()=>Xn,sqrLen:()=>On,squaredDistance:()=>yr,squaredLength:()=>wr,str:()=>Sn,sub:()=>Ln,subtract:()=>mr,transformMat3:()=>gn,transformMat4:()=>dn,transformQuat:()=>_n,zero:()=>En});function $(){var r=new P(3);return P!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function ue(r){var e=new P(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function Mr(r){var e=r[0],n=r[1],a=r[2];return Math.hypot(e,n,a)}function Q(r,e,n){var a=new P(3);return a[0]=r,a[1]=e,a[2]=n,a}function rn(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r}function en(r,e,n,a){return r[0]=e,r[1]=n,r[2]=a,r}function nn(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r[2]=e[2]+n[2],r}function mr(r,e,n){return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],r}function dr(r,e,n){return r[0]=e[0]*n[0],r[1]=e[1]*n[1],r[2]=e[2]*n[2],r}function gr(r,e,n){return r[0]=e[0]/n[0],r[1]=e[1]/n[1],r[2]=e[2]/n[2],r}function an(r,e){return r[0]=Math.ceil(e[0]),r[1]=Math.ceil(e[1]),r[2]=Math.ceil(e[2]),r}function tn(r,e){return r[0]=Math.floor(e[0]),r[1]=Math.floor(e[1]),r[2]=Math.floor(e[2]),r}function sn(r,e,n){return r[0]=Math.min(e[0],n[0]),r[1]=Math.min(e[1],n[1]),r[2]=Math.min(e[2],n[2]),r}function cn(r,e,n){return r[0]=Math.max(e[0],n[0]),r[1]=Math.max(e[1],n[1]),r[2]=Math.max(e[2],n[2]),r}function vn(r,e){return r[0]=Math.round(e[0]),r[1]=Math.round(e[1]),r[2]=Math.round(e[2]),r}function ln(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r}function hn(r,e,n,a){return r[0]=e[0]+n[0]*a,r[1]=e[1]+n[1]*a,r[2]=e[2]+n[2]*a,r}function _r(r,e){var n=e[0]-r[0],a=e[1]-r[1],i=e[2]-r[2];return Math.hypot(n,a,i)}function yr(r,e){var n=e[0]-r[0],a=e[1]-r[1],i=e[2]-r[2];return n*n+a*a+i*i}function wr(r){var e=r[0],n=r[1],a=r[2];return e*e+n*n+a*a}function fn(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function on(r,e){return r[0]=1/e[0],r[1]=1/e[1],r[2]=1/e[2],r}function rr(r,e){var n=e[0],a=e[1],i=e[2],t=n*n+a*a+i*i;return t>0&&(t=1/Math.sqrt(t)),r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r}function K(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function G(r,e,n){var a=e[0],i=e[1],t=e[2],s=n[0],c=n[1],v=n[2];return r[0]=i*v-t*c,r[1]=t*s-a*v,r[2]=a*c-i*s,r}function pn(r,e,n,a){var i=e[0],t=e[1],s=e[2];return r[0]=i+a*(n[0]-i),r[1]=t+a*(n[1]-t),r[2]=s+a*(n[2]-s),r}function xn(r,e,n,a,i,t){var s=t*t,c=s*(2*t-3)+1,v=s*(t-2)+t,l=s*(t-1),h=s*(3-2*t);return r[0]=e[0]*c+n[0]*v+a[0]*l+i[0]*h,r[1]=e[1]*c+n[1]*v+a[1]*l+i[1]*h,r[2]=e[2]*c+n[2]*v+a[2]*l+i[2]*h,r}function Mn(r,e,n,a,i,t){var s=1-t,c=s*s,v=t*t,l=c*s,h=3*t*c,f=3*v*s,x=v*t;return r[0]=e[0]*l+n[0]*h+a[0]*f+i[0]*x,r[1]=e[1]*l+n[1]*h+a[1]*f+i[1]*x,r[2]=e[2]*l+n[2]*h+a[2]*f+i[2]*x,r}function mn(r,e){e=e||1;var n=q()*2*Math.PI,a=q()*2-1,i=Math.sqrt(1-a*a)*e;return r[0]=Math.cos(n)*i,r[1]=Math.sin(n)*i,r[2]=a*e,r}function dn(r,e,n){var a=e[0],i=e[1],t=e[2],s=n[3]*a+n[7]*i+n[11]*t+n[15];return s=s||1,r[0]=(n[0]*a+n[4]*i+n[8]*t+n[12])/s,r[1]=(n[1]*a+n[5]*i+n[9]*t+n[13])/s,r[2]=(n[2]*a+n[6]*i+n[10]*t+n[14])/s,r}function gn(r,e,n){var a=e[0],i=e[1],t=e[2];return r[0]=a*n[0]+i*n[3]+t*n[6],r[1]=a*n[1]+i*n[4]+t*n[7],r[2]=a*n[2]+i*n[5]+t*n[8],r}function _n(r,e,n){var a=n[0],i=n[1],t=n[2],s=n[3],c=e[0],v=e[1],l=e[2],h=i*l-t*v,f=t*c-a*l,x=a*v-i*c,p=i*x-t*f,m=t*h-a*x,M=a*f-i*h,o=s*2;return h*=o,f*=o,x*=o,p*=2,m*=2,M*=2,r[0]=c+h+p,r[1]=v+f+m,r[2]=l+x+M,r}function yn(r,e,n,a){var i=[],t=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],t[0]=i[0],t[1]=i[1]*Math.cos(a)-i[2]*Math.sin(a),t[2]=i[1]*Math.sin(a)+i[2]*Math.cos(a),r[0]=t[0]+n[0],r[1]=t[1]+n[1],r[2]=t[2]+n[2],r}function wn(r,e,n,a){var i=[],t=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],t[0]=i[2]*Math.sin(a)+i[0]*Math.cos(a),t[1]=i[1],t[2]=i[2]*Math.cos(a)-i[0]*Math.sin(a),r[0]=t[0]+n[0],r[1]=t[1]+n[1],r[2]=t[2]+n[2],r}function Rn(r,e,n,a){var i=[],t=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],t[0]=i[0]*Math.cos(a)-i[1]*Math.sin(a),t[1]=i[0]*Math.sin(a)+i[1]*Math.cos(a),t[2]=i[2],r[0]=t[0]+n[0],r[1]=t[1]+n[1],r[2]=t[2]+n[2],r}function An(r,e){var n=r[0],a=r[1],i=r[2],t=e[0],s=e[1],c=e[2],v=Math.sqrt(n*n+a*a+i*i),l=Math.sqrt(t*t+s*s+c*c),h=v*l,f=h&&K(r,e)/h;return Math.acos(Math.min(Math.max(f,-1),1))}function En(r){return r[0]=0,r[1]=0,r[2]=0,r}function Sn(r){return"vec3("+r[0]+", "+r[1]+", "+r[2]+")"}function Pn(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}function bn(r,e){var n=r[0],a=r[1],i=r[2],t=e[0],s=e[1],c=e[2];return Math.abs(n-t)<=R*Math.max(1,Math.abs(n),Math.abs(t))&&Math.abs(a-s)<=R*Math.max(1,Math.abs(a),Math.abs(s))&&Math.abs(i-c)<=R*Math.max(1,Math.abs(i),Math.abs(c))}var Ln=mr,Tn=dr,zn=gr,In=_r,Xn=yr,er=Mr,On=wr,Fn=function(){var r=$();return function(e,n,a,i,t,s){var c,v;for(n||(n=3),a||(a=0),i?v=Math.min(i*n+a,e.length):v=e.length,c=a;c<v;c+=n)r[0]=e[c],r[1]=e[c+1],r[2]=e[c+2],t(r,r,s),e[c]=r[0],e[c+1]=r[1],e[c+2]=r[2];return e}}();function Nn(){var r=new P(4);return P!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function Rr(r){var e=new P(4);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e}function Ar(r,e,n,a){var i=new P(4);return i[0]=r,i[1]=e,i[2]=n,i[3]=a,i}function Er(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r}function Sr(r,e,n,a,i){return r[0]=e,r[1]=n,r[2]=a,r[3]=i,r}function Pr(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r[2]=e[2]+n[2],r[3]=e[3]+n[3],r}function br(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r[3]=e[3]*n,r}function Lr(r){var e=r[0],n=r[1],a=r[2],i=r[3];return Math.hypot(e,n,a,i)}function Tr(r){var e=r[0],n=r[1],a=r[2],i=r[3];return e*e+n*n+a*a+i*i}function zr(r,e){var n=e[0],a=e[1],i=e[2],t=e[3],s=n*n+a*a+i*i+t*t;return s>0&&(s=1/Math.sqrt(s)),r[0]=n*s,r[1]=a*s,r[2]=i*s,r[3]=t*s,r}function Ir(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]+r[3]*e[3]}function Xr(r,e,n,a){var i=e[0],t=e[1],s=e[2],c=e[3];return r[0]=i+a*(n[0]-i),r[1]=t+a*(n[1]-t),r[2]=s+a*(n[2]-s),r[3]=c+a*(n[3]-c),r}function Or(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]}function Fr(r,e){var n=r[0],a=r[1],i=r[2],t=r[3],s=e[0],c=e[1],v=e[2],l=e[3];return Math.abs(n-s)<=R*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(a-c)<=R*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(i-v)<=R*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(t-l)<=R*Math.max(1,Math.abs(t),Math.abs(l))}var Ja=function(){var r=Nn();return function(e,n,a,i,t,s){var c,v;for(n||(n=4),a||(a=0),i?v=Math.min(i*n+a,e.length):v=e.length,c=a;c<v;c+=n)r[0]=e[c],r[1]=e[c+1],r[2]=e[c+2],r[3]=e[c+3],t(r,r,s),e[c]=r[0],e[c+1]=r[1],e[c+2]=r[2],e[c+3]=r[3];return e}}();function nr(){var r=new P(4);return P!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function qn(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function Nr(r,e,n){n=n*.5;var a=Math.sin(n);return r[0]=a*e[0],r[1]=a*e[1],r[2]=a*e[2],r[3]=Math.cos(n),r}function Cn(r,e){var n=Math.acos(e[3])*2,a=Math.sin(n/2);return a>R?(r[0]=e[0]/a,r[1]=e[1]/a,r[2]=e[2]/a):(r[0]=1,r[1]=0,r[2]=0),n}function Yn(r,e){var n=Dr(r,e);return Math.acos(2*n*n-1)}function Vr(r,e,n){var a=e[0],i=e[1],t=e[2],s=e[3],c=n[0],v=n[1],l=n[2],h=n[3];return r[0]=a*h+s*c+i*l-t*v,r[1]=i*h+s*v+t*c-a*l,r[2]=t*h+s*l+a*v-i*c,r[3]=s*h-a*c-i*v-t*l,r}function kn(r,e,n){n*=.5;var a=e[0],i=e[1],t=e[2],s=e[3],c=Math.sin(n),v=Math.cos(n);return r[0]=a*v+s*c,r[1]=i*v+t*c,r[2]=t*v-i*c,r[3]=s*v-a*c,r}function Dn(r,e,n){n*=.5;var a=e[0],i=e[1],t=e[2],s=e[3],c=Math.sin(n),v=Math.cos(n);return r[0]=a*v-t*c,r[1]=i*v+s*c,r[2]=t*v+a*c,r[3]=s*v-i*c,r}function Wn(r,e,n){n*=.5;var a=e[0],i=e[1],t=e[2],s=e[3],c=Math.sin(n),v=Math.cos(n);return r[0]=a*v+i*c,r[1]=i*v-a*c,r[2]=t*v+s*c,r[3]=s*v-t*c,r}function Un(r,e){var n=e[0],a=e[1],i=e[2];return r[0]=n,r[1]=a,r[2]=i,r[3]=Math.sqrt(Math.abs(1-n*n-a*a-i*i)),r}function qr(r,e){var n=e[0],a=e[1],i=e[2],t=e[3],s=Math.sqrt(n*n+a*a+i*i),c=Math.exp(t),v=s>0?c*Math.sin(s)/s:0;return r[0]=n*v,r[1]=a*v,r[2]=i*v,r[3]=c*Math.cos(s),r}function Cr(r,e){var n=e[0],a=e[1],i=e[2],t=e[3],s=Math.sqrt(n*n+a*a+i*i),c=s>0?Math.atan2(s,t)/s:0;return r[0]=n*c,r[1]=a*c,r[2]=i*c,r[3]=.5*Math.log(n*n+a*a+i*i+t*t),r}function Gn(r,e,n){return Cr(r,e),kr(r,r,n),qr(r,r),r}function Z(r,e,n,a){var i=e[0],t=e[1],s=e[2],c=e[3],v=n[0],l=n[1],h=n[2],f=n[3],x,p,m,M,o;return p=i*v+t*l+s*h+c*f,p<0&&(p=-p,v=-v,l=-l,h=-h,f=-f),1-p>R?(x=Math.acos(p),m=Math.sin(x),M=Math.sin((1-a)*x)/m,o=Math.sin(a*x)/m):(M=1-a,o=a),r[0]=M*i+o*v,r[1]=M*t+o*l,r[2]=M*s+o*h,r[3]=M*c+o*f,r}function Bn(r){var e=q(),n=q(),a=q(),i=Math.sqrt(1-e),t=Math.sqrt(e);return r[0]=i*Math.sin(2*Math.PI*n),r[1]=i*Math.cos(2*Math.PI*n),r[2]=t*Math.sin(2*Math.PI*a),r[3]=t*Math.cos(2*Math.PI*a),r}function Hn(r,e){var n=e[0],a=e[1],i=e[2],t=e[3],s=n*n+a*a+i*i+t*t,c=s?1/s:0;return r[0]=-n*c,r[1]=-a*c,r[2]=-i*c,r[3]=t*c,r}function jn(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r}function Yr(r,e){var n=e[0]+e[4]+e[8],a;if(n>0)a=Math.sqrt(n+1),r[3]=.5*a,a=.5/a,r[0]=(e[5]-e[7])*a,r[1]=(e[6]-e[2])*a,r[2]=(e[1]-e[3])*a;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var t=(i+1)%3,s=(i+2)%3;a=Math.sqrt(e[i*3+i]-e[t*3+t]-e[s*3+s]+1),r[i]=.5*a,a=.5/a,r[3]=(e[t*3+s]-e[s*3+t])*a,r[t]=(e[t*3+i]+e[i*3+t])*a,r[s]=(e[s*3+i]+e[i*3+s])*a}return r}function $n(r,e,n,a){var i=.5*Math.PI/180;e*=i,n*=i,a*=i;var t=Math.sin(e),s=Math.cos(e),c=Math.sin(n),v=Math.cos(n),l=Math.sin(a),h=Math.cos(a);return r[0]=t*v*h-s*c*l,r[1]=s*c*h+t*v*l,r[2]=s*v*l-t*c*h,r[3]=s*v*h+t*c*l,r}function Qn(r){return"quat("+r[0]+", "+r[1]+", "+r[2]+", "+r[3]+")"}var Kn=Rr,Zn=Ar,Jn=Er,un=Sr,ra=Pr,ea=Vr,kr=br,Dr=Ir,na=Xr,Wr=Lr,aa=Wr,Ur=Tr,ia=Ur,ar=zr,ta=Or,sa=Fr,ca=function(){var r=$(),e=Q(1,0,0),n=Q(0,1,0);return function(a,i,t){var s=K(i,t);return s<-.999999?(G(r,e,i),er(r)<1e-6&&G(r,n,i),rr(r,r),Nr(a,r,Math.PI),a):s>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(G(r,i,t),a[0]=r[0],a[1]=r[1],a[2]=r[2],a[3]=1+s,ar(a,a))}}(),va=function(){var r=nr(),e=nr();return function(n,a,i,t,s,c){return Z(r,a,s,c),Z(e,i,t,c),Z(n,r,e,2*c*(1-c)),n}}(),la=function(){var r=cr();return function(e,n,a,i){return r[0]=a[0],r[3]=a[1],r[6]=a[2],r[1]=i[0],r[4]=i[1],r[7]=i[2],r[2]=-n[0],r[5]=-n[1],r[8]=-n[2],ar(e,Yr(e,r))}}();var J={};W(J,{add:()=>xa,angle:()=>Fa,ceil:()=>Ma,clone:()=>ha,copy:()=>oa,create:()=>Gr,cross:()=>Pa,dist:()=>Ua,distance:()=>$r,div:()=>Wa,divide:()=>jr,dot:()=>Sa,equals:()=>Ca,exactEquals:()=>qa,floor:()=>ma,forEach:()=>Ha,fromValues:()=>fa,inverse:()=>Aa,len:()=>Ya,length:()=>Kr,lerp:()=>ba,max:()=>ga,min:()=>da,mul:()=>Da,multiply:()=>Hr,negate:()=>Ra,normalize:()=>Ea,random:()=>La,rotate:()=>Oa,round:()=>_a,scale:()=>ya,scaleAndAdd:()=>wa,set:()=>pa,sqrDist:()=>Ga,sqrLen:()=>Ba,squaredDistance:()=>Qr,squaredLength:()=>Zr,str:()=>Va,sub:()=>ka,subtract:()=>Br,transformMat2:()=>Ta,transformMat2d:()=>za,transformMat3:()=>Ia,transformMat4:()=>Xa,zero:()=>Na});function Gr(){var r=new P(2);return P!=Float32Array&&(r[0]=0,r[1]=0),r}function ha(r){var e=new P(2);return e[0]=r[0],e[1]=r[1],e}function fa(r,e){var n=new P(2);return n[0]=r,n[1]=e,n}function oa(r,e){return r[0]=e[0],r[1]=e[1],r}function pa(r,e,n){return r[0]=e,r[1]=n,r}function xa(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r}function Br(r,e,n){return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r}function Hr(r,e,n){return r[0]=e[0]*n[0],r[1]=e[1]*n[1],r}function jr(r,e,n){return r[0]=e[0]/n[0],r[1]=e[1]/n[1],r}function Ma(r,e){return r[0]=Math.ceil(e[0]),r[1]=Math.ceil(e[1]),r}function ma(r,e){return r[0]=Math.floor(e[0]),r[1]=Math.floor(e[1]),r}function da(r,e,n){return r[0]=Math.min(e[0],n[0]),r[1]=Math.min(e[1],n[1]),r}function ga(r,e,n){return r[0]=Math.max(e[0],n[0]),r[1]=Math.max(e[1],n[1]),r}function _a(r,e){return r[0]=Math.round(e[0]),r[1]=Math.round(e[1]),r}function ya(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r}function wa(r,e,n,a){return r[0]=e[0]+n[0]*a,r[1]=e[1]+n[1]*a,r}function $r(r,e){var n=e[0]-r[0],a=e[1]-r[1];return Math.hypot(n,a)}function Qr(r,e){var n=e[0]-r[0],a=e[1]-r[1];return n*n+a*a}function Kr(r){var e=r[0],n=r[1];return Math.hypot(e,n)}function Zr(r){var e=r[0],n=r[1];return e*e+n*n}function Ra(r,e){return r[0]=-e[0],r[1]=-e[1],r}function Aa(r,e){return r[0]=1/e[0],r[1]=1/e[1],r}function Ea(r,e){var n=e[0],a=e[1],i=n*n+a*a;return i>0&&(i=1/Math.sqrt(i)),r[0]=e[0]*i,r[1]=e[1]*i,r}function Sa(r,e){return r[0]*e[0]+r[1]*e[1]}function Pa(r,e,n){var a=e[0]*n[1]-e[1]*n[0];return r[0]=r[1]=0,r[2]=a,r}function ba(r,e,n,a){var i=e[0],t=e[1];return r[0]=i+a*(n[0]-i),r[1]=t+a*(n[1]-t),r}function La(r,e){e=e||1;var n=q()*2*Math.PI;return r[0]=Math.cos(n)*e,r[1]=Math.sin(n)*e,r}function Ta(r,e,n){var a=e[0],i=e[1];return r[0]=n[0]*a+n[2]*i,r[1]=n[1]*a+n[3]*i,r}function za(r,e,n){var a=e[0],i=e[1];return r[0]=n[0]*a+n[2]*i+n[4],r[1]=n[1]*a+n[3]*i+n[5],r}function Ia(r,e,n){var a=e[0],i=e[1];return r[0]=n[0]*a+n[3]*i+n[6],r[1]=n[1]*a+n[4]*i+n[7],r}function Xa(r,e,n){var a=e[0],i=e[1];return r[0]=n[0]*a+n[4]*i+n[12],r[1]=n[1]*a+n[5]*i+n[13],r}function Oa(r,e,n,a){var i=e[0]-n[0],t=e[1]-n[1],s=Math.sin(a),c=Math.cos(a);return r[0]=i*c-t*s+n[0],r[1]=i*s+t*c+n[1],r}function Fa(r,e){var n=r[0],a=r[1],i=e[0],t=e[1],s=Math.sqrt(n*n+a*a)*Math.sqrt(i*i+t*t),c=s&&(n*i+a*t)/s;return Math.acos(Math.min(Math.max(c,-1),1))}function Na(r){return r[0]=0,r[1]=0,r}function Va(r){return"vec2("+r[0]+", "+r[1]+")"}function qa(r,e){return r[0]===e[0]&&r[1]===e[1]}function Ca(r,e){var n=r[0],a=r[1],i=e[0],t=e[1];return Math.abs(n-i)<=R*Math.max(1,Math.abs(n),Math.abs(i))&&Math.abs(a-t)<=R*Math.max(1,Math.abs(a),Math.abs(t))}var Ya=Kr,ka=Br,Da=Hr,Wa=jr,Ua=$r,Ga=Qr,Ba=Zr,Ha=function(){var r=Gr();return function(e,n,a,i,t,s){var c,v;for(n||(n=2),a||(a=0),i?v=Math.min(i*n+a,e.length):v=e.length,c=a;c<v;c+=n)r[0]=e[c],r[1]=e[c+1],t(r,r,s),e[c]=r[0],e[c+1]=r[1];return e}}();var Jr=require("@3dverse/livelink"),u=class extends Jr.ContextProvider{#s;#l=null;#e=null;#n=null;#i=null;screen_distance=25;scale_factor=1;fake_alpha_enabled=!1;fake_alpha_scale=1;#o=N.fromValues(0,0,-1);#t=N.create();#a=U.create();#r=J.create();#h=N.create();#v=B.create();#c=N.create();get native(){return this.#s}set frame_buffer(e){this.#n=e}constructor(e,n="webgl",a){super();let i=e.getContext(n,a);if(i===null)throw new Error(`Cannot create a ${n} context from canvas`);this.#s=i,this.#p(),this.#m(),this.#d()}drawFrameSection({frame_section:e}){this.#i=e}get meta_data(){return this.#i?.meta_data||null}drawXRFrame({xr_views:e,xr_viewports:n,frame_camera_transforms:a}){if(!this.#i)return;let i=this.#s;this.#n!==null&&i.bindFramebuffer(i.FRAMEBUFFER,this.#n),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA);let t=i.getUniformLocation(this.#e,"size"),s=i.getUniformLocation(this.#e,"offset"),c=i.getUniformLocation(this.#e,"viewMatrix"),v=i.getUniformLocation(this.#e,"viewOffset"),l=i.getUniformLocation(this.#e,"projectionMatrix"),h=i.getUniformLocation(this.#e,"billboardMatrix"),f=i.getUniformLocation(this.#e,"fakeAlphaEnabled"),x=i.getUniformLocation(this.#e,"fakeAlphaScale");i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.#l),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this.#i.pixels);let p=Math.atan(1/e[0].projectionMatrix[5])*2,m=n[0].width/n[0].height,M=this.scale_factor*this.screen_distance*Math.tan(p*.5),o=M*m,d=this.#i.section.width/e.length,A=this.#i.section.height;i.uniform2fv(t,[d,A]);let w=n.reduce((g,{width:_})=>g+_,0);for(let g=0;g<e.length;g++){let _=e[g],y=n[g],S=a[g];N.set(this.#h,S.position[0],S.position[1],S.position[2]),B.set(this.#v,S.orientation[0],S.orientation[1],S.orientation[2],S.orientation[3]),N.transformQuat(this.#c,this.#o,this.#v),N.scaleAndAdd(this.#t,this.#h,this.#c,this.screen_distance),this.#r[0]=_.projectionMatrix[8],this.#r[1]=_.projectionMatrix[9];let b=this.#f(this.#t,o,M);i.uniform2fv(v,this.#r),i.viewport(y.x,y.y,y.width,y.height),i.uniformMatrix4fv(c,!1,_.transform.inverse.matrix),i.uniformMatrix4fv(l,!1,_.projectionMatrix),i.uniformMatrix4fv(h,!1,b),i.uniform1i(f,this.fake_alpha_enabled?1:0),i.uniform1f(x,this.fake_alpha_scale);let L=y.x/w,T=this.#i.section.left+L*this.#i.section.width;i.uniform2fv(s,[T,this.#i.section.top]),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}refreshSize(){}release(){let e=this.#s;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.bindFramebuffer(e.FRAMEBUFFER,null)}#f(e,n,a){return U.fromRotationTranslationScale(this.#a,this.#v,e,N.fromValues(n,a,1)),this.#a}#p(){let e=this.#s,n=`
            attribute vec2 position;
            varying vec2 texCoord;

            uniform mat4 viewMatrix;
            uniform mat4 projectionMatrix;
            uniform vec2 scale;
            uniform mat4 billboardMatrix;

            uniform vec2 size;
            uniform vec2 offset;
            uniform vec2 viewOffset;

            void main() {
                texCoord = (position + 1.0) * 0.5;
                texCoord.y = 1.0 - texCoord.y;
                texCoord = size * texCoord + offset;
                gl_Position = projectionMatrix * viewMatrix * billboardMatrix * vec4(position + viewOffset, 0.0, 1.0);
            }`,a=e.createShader(e.VERTEX_SHADER);e.shaderSource(a,n),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||console.error("Vertex shader failed to compile: "+e.getShaderInfoLog(a));let i=`
            precision mediump float;
            varying vec2 texCoord;
            uniform sampler2D texture;
            uniform int fakeAlphaEnabled;
            uniform float fakeAlphaScale;

            float luminance(vec3 color) {
                // sRGB luminance approximation
                return dot(color, vec3(0.299, 0.587, 0.114));
            }

            void main() {
                gl_FragColor = texture2D(texture, texCoord);
                if(fakeAlphaEnabled == 1) {
                    // Use luminance to determine alpha so values close to dark are transparent and smoothly fade
                    // to prevent noise around object's edges
                    float luma = luminance(gl_FragColor.rgb);
                    float alpha = smoothstep(0.02, 0.1, luma);
                    gl_FragColor.a = alpha;

                    // remap [0..1] \u2192 [0..fakeAlphaScale] to see through opaque objects in AR
                    if(fakeAlphaScale < 1.0) {
                        gl_FragColor.a *= fakeAlphaScale;
                    }

                    // Premultiply RGB by alpha to avoid color bleeding on transparent edges
                    // (required for correct blending in compositing / XR rendering)
                    gl_FragColor.rgb *= alpha;
                }
            }`,t=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(t,i),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||console.error("Fragment shader failed to compile: "+e.getShaderInfoLog(t));let s=e.createProgram();e.attachShader(s,a),e.attachShader(s,t),e.linkProgram(s),e.useProgram(s),e.getProgramParameter(s,e.LINK_STATUS)||console.error("Program failed to compile: "+e.getProgramInfoLog(s)),e.useProgram(s),this.#e=s}#m(){let e=this.#s,n=e.createBuffer(),a=new Float32Array([1,1,-1,1,1,-1,-1,-1]);e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW);let i=e.getAttribLocation(this.#e,"position");e.enableVertexAttribArray(i),e.vertexAttribPointer(i,2,e.FLOAT,!1,0,0)}#d(){let e=this.#s;this.#l=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.#l),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null);let n=e.getUniformLocation(this.#e,"texture");e.uniform1i(n,0)}};var F=require("threejs-math");function ja(){let r,e;return{promise:new Promise((a,i)=>{r=a,e=i}),resolve:r,reject:e}}var H=class r{cameras_origin=null;#s;#l;#e=null;#n;#i;#o;#t=[];#a;#r=null;#h="inline";#v=!1;#c=null;#f=[];#p=0;static async isSessionSupported(e){if(!navigator.xr)return!1;let n=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return n?await n.call(navigator.xr,e).catch(console.warn)??!1:!1}get session(){return this.#r}get mode(){return this.#h}get reference_space(){return this.#c}get is_stereo_vision(){return this.#f.length===2}set overriden_near_plane(e){this.#i=e}set cameras_origin_transform_enabled(e){e?(this.#x=this.#s,this.#M=this.#l):(this.#x=()=>{},this.#M=()=>{})}constructor(e=1){this.#n=new C.OffscreenSurface({width:window.innerWidth,height:window.innerHeight,context_constructor:u,context_type:"webgl",context_options:{xrCompatible:!0},resolution_scale:e}),this.#a=this.#n.context,this.#s=this.#x,this.#l=this.#M}async release(){if(this.#r&&(this.stop(),await this.#r.end().catch(e=>console.warn("Could not end XR session:",e))),this.#e)for(let{livelink_viewport:e}of this.#t)this.#e.removeViewport({viewport:e});this.#n.release()}get fakeAlpha(){return this.#a.fake_alpha_enabled}set fakeAlpha(e){this.#a.fake_alpha_enabled=e}get fakeAlphaScale(){return this.#a.fake_alpha_scale}set fakeAlphaScale(e){if(e<0||e>1)throw new Error("Fake alpha scale must be between 0 and 1");this.#a.fake_alpha_scale=e}async initialize(e,{xrSessionInit:n={},forceSingleView:a=!1}){if(this.#h=e,this.#v=a,!r.isSessionSupported(e))throw new Error(`WebXR "${e}" not supported`);this.#r&&(console.warn("Releasing previous XR session"),await this.release());let i=["local-floor","local"],t;for(let s of i){let c=s?{...n,requiredFeatures:[...n.requiredFeatures||[],s]}:n;try{this.#r=await navigator.xr.requestSession(e,c),await this.updateRenderState(),await this.setReferenceSpaceType(s);break}catch(v){console.warn("Failed to request XR session",{spaceType:s,requiredFeatures:c.requiredFeatures},v),this.#r?.end(),t=v}}if(!this.#r)throw t;return this.#r}async configureViewports({livelink:e,overscan_fov_factor:n,enable_overscan_surface_scale:a,enable_fake_alpha:i}){this.#e&&this.releaseLivelinkViewports(),this.#e=e;let t=await this.#m();t.length>2&&console.error("WebXRHelper doesn't support more than 2 eyes yet"),this.#w(t),this.#d({xr_views:t,fov_factor:n,enable_surface_scale:a});let s=this.#h==="immersive-ar";this.fakeAlpha=i??s;let c=s?{grid:!1,displayBackground:!1}:void 0;this.#e.addViewports({viewports:this.#t.map(({livelink_viewport:v})=>v)});for(let v in this.#t){let{xr_view:l,xr_viewport:h,livelink_viewport:f}=this.#t[v];await this.#R({index:v,xr_view:l,xr_viewport:h,viewport:f,dataJSON:c})}}#m(){let{promise:e,resolve:n,reject:a}=ja(),i=200,t=async(s,c)=>{let v=c.getViewerPose(this.#c)?.views;if(!v){--i>0?this.#r.requestAnimationFrame(t):a(new Error("Failed to get XR views."));return}this.#v&&v.length>1?(console.log("WebXRHelper: forcing single view"),n(v.slice(0,1))):n(v)};return this.#p=this.#r.requestAnimationFrame(t),e}#d({xr_views:e,fov_factor:n=1.5,enable_surface_scale:a=!0}){if(n===1)return;a?(this.#n.resolution_scale=n,this.#a.scale_factor=this.#n.resolution_scale):this.#a.scale_factor=n;let i=e[0].projectionMatrix[5],t=2*Math.atan(1/i),s=2*Math.atan(Math.tan(t/2)*n);this.#o=s*(180/Math.PI),t*(180/Math.PI),`${this.#o}${this.#a.scale_factor}${this.#n.resolution_scale}`}start(){this.#r.requestAnimationFrame(this.#g)}stop(){this.#p&&this.#r&&this.#r.cancelAnimationFrame(this.#p)}async setReferenceSpaceType(e="local"){return this.#c=await this.#r.requestReferenceSpace(e).catch(async n=>{throw console.error(`Failed to request XR reference space of type ${e}:`,n),n}),this.#c}async updateRenderState(e={}){let n=this.#r,a=new XRWebGLLayer(n,this.#a.native,e);await n.updateRenderState({baseLayer:a}),this.#a.frame_buffer=a.framebuffer,this.#n.resize(a.framebufferWidth,a.framebufferHeight)}#x=e=>{if(!this.cameras_origin)return;let n=new F.Vector3().fromArray(this.cameras_origin.position),a=new F.Quaternion().fromArray(this.cameras_origin.orientation),i=new F.Vector3().fromArray(this.cameras_origin.scale),t=new F.Matrix4().compose(n,a,i).invert(),s=a.conjugate();for(let c of e){let{position:v,orientation:l}=c.global_transform,h=new F.Vector3().fromArray(v);h.applyMatrix4(t),h.toArray(v);let f=new F.Quaternion().fromArray(l);new F.Quaternion().multiplyQuaternions(s,f).toArray(l)}};#M=e=>{if(!this.cameras_origin)return;let n=new F.Vector3().fromArray(this.cameras_origin.position),a=new F.Quaternion().fromArray(this.cameras_origin.orientation),i=new F.Vector3().fromArray(this.cameras_origin.scale),t=new F.Matrix4().compose(n,a,i);for(let s of e){let{position:c,orientation:v}=s,l=new F.Vector3().fromArray(c);l.applyMatrix4(t),l.toArray(c);let h=new F.Quaternion().fromArray(v);new F.Quaternion().multiplyQuaternions(a,h).toArray(v)}};#g=(e,n)=>{let a=this.#r,i=a.renderState.baseLayer,t=n.getViewerPose(this.#c)?.views;if(!t){a.requestAnimationFrame(this.#g);return}let s=[...t],c=[];s.forEach(l=>{c.push(i.getViewport(l))}),this.#v&&(s=s.splice(0,1),c=c.splice(0,1)),this.#A(c)&&(console.error("XRViewports have changed, ending the XRSession"),a.end()),this.#y(s),this.#x(this.#n.cameras);let v=c.map((l,h)=>{let f=this.#n.viewports[h],{world_position:x,world_orientation:p}=f.camera_projection;return{position:Array.from(x),orientation:Array.from(p)}});this.#M(v),this.#a.drawXRFrame({xr_views:s,xr_viewports:c,frame_camera_transforms:v}),a.requestAnimationFrame(this.#g)};#y(e){this.#n.cameras.forEach((n,a)=>{let i=e[a],{position:t,orientation:s}=i.transform,{livelink_viewport:c}=this.#t[a],v=[t.x,t.y,t.z],l=[s.x,s.y,s.z,s.w];n.local_transform={position:v,orientation:l};let h=this.#_(i.projectionMatrix,c.width,c.height),{fovy:f,nearPlane:x,farPlane:p,offset:m}=h;(!n.perspective_lens||n.perspective_lens.fovy!==f||n.perspective_lens.nearPlane!==x||n.perspective_lens.farPlane!==p||n.perspective_lens.offset!==m)&&(n.perspective_lens=h)})}#w(e){let n=this.#r.renderState.baseLayer,a=e.map(s=>({view:s,viewport:n.getViewport(s)})),i=a.map(s=>s.viewport);this.#f=i;let t=a.every(({viewport:s})=>s.x<=1&&s.y<=1&&s.width<=1&&s.height<=1);for(let s of a){let c=s.viewport,v=new C.RelativeRect(t?{left:c.x,top:c.y,width:c.width,height:c.height}:{left:c.x/n.framebufferWidth,top:c.y/n.framebufferHeight,width:c.width/n.framebufferWidth,height:c.height/n.framebufferHeight});`${s.view.eye}`;let l=new C.Viewport({core:this.#e,rendering_surface:this.#n,options:{rect:v}});this.#t.push({xr_view:s.view,xr_viewport:c,livelink_viewport:l})}}releaseLivelinkViewports(){for(let e of this.#t)this.#n.removeViewport({viewport:e.livelink_viewport});this.#t.length=0}async#R({index:e,xr_view:n,xr_viewport:a,viewport:i,dataJSON:t}){let s=await this.#e.scene.newEntity({name:`XR_camera_${n.eye}_${e}`,components:{local_transform:{},perspective_lens:this.#_(n.projectionMatrix,i.width,i.height),camera:{renderGraphRef:"398ee642-030a-45e7-95df-7147f6c43392",dataJSON:t},tags:{value:[`viewport_x = ${a.x.toString()}`,`viewport_y = ${a.y.toString()}`,`viewport_width = ${a.width.toString()}`,`viewport_height = ${a.height.toString()}`,`recommanded_scale = ${n.recommendedViewportScale?.toString()||"?"}`]}},options:{delete_on_client_disconnection:!0,auto_broadcast:!1}});i.camera_projection=new C.CameraProjection({camera_entity:s,viewport:i}),`${n.eye}`}#_(e,n,a){let i=n/a,t=this.#o??Math.atan(1/e[5])*(180/Math.PI)*2,s=e[14]/(e[10]-1);this.is_stereo_vision&&this.cameras_origin&&this.cameras_origin.scale[0]!==1&&(s*=1/this.cameras_origin.scale[0]);let c=e[14]/(e[10]+1),v=[e[8],e[9]*-1];return{fovy:t,aspectRatio:i,nearPlane:this.#i||s,farPlane:c,offset:v}}#A(e){return this.#f.length===0?!0:e.some((n,a)=>{let i=this.#f[a];return i?i.width!==n.width||i.height!==n.height||i.x!==n.x||i.y!==n.y:!0})}get resolution_scale(){return this.#n.resolution_scale}set resolution_scale(e){this.#n.resolution_scale=e}};var z=se(require("react")),ur=require("@3dverse/livelink-react");var re=(0,z.createContext)({webXRHelper:null,xrSession:null});function $a({children:r,mode:e,resolutionScale:n=1,requiredFeatures:a=[],optionalFeatures:i=[],forceSingleView:t,overscanFovFactor:s,enableOverscanSurfaceScale:c,enableFakeAlpha:v,domOverlayRoot:l,onSessionEnd:h}){let{instance:f}=(0,z.useContext)(ur.LivelinkContext),x=(0,z.useRef)(null),p=(0,z.useMemo)(()=>new H(n),[e,a.join("-"),i.join("-"),t,l]),m=(0,z.useRef)(null),[M,o]=(0,z.useState)(null);return(0,z.useEffect)(()=>{p&&(p.resolution_scale=n)},[p,n]),(0,z.useEffect)(()=>{if(!(!M||!h))return M.addEventListener("end",h),()=>{M.removeEventListener("end",h)}},[M,h]),(0,z.useEffect)(()=>{let d=l||x.current;if(!(!d||!f))return m.current||(m.current=p.initialize(e,{xrSessionInit:{requiredFeatures:a,optionalFeatures:["dom-overlay",...i],domOverlay:{root:d}},forceSingleView:t}).then(A=>(o(A),p.configureViewports({livelink:f,overscan_fov_factor:s,enable_overscan_surface_scale:c,enable_fake_alpha:v}))).then(()=>{p.start(),m.current=null})),()=>{p.release(),o(null)}},[p,f]),z.default.createElement(re.Provider,{value:{webXRHelper:p,xrSession:M}},l?z.default.createElement(z.default.Fragment,null,r):z.default.createElement("div",{"data-role":"webxr-dom-overlay",ref:x},r))}typeof window<"u"&&(window.__LIVELINK__||(window.__LIVELINK__={}),Object.prototype.hasOwnProperty.call(window.__LIVELINK__,"@3dverse/livelink-webxr")?console.warn("\u26A0\uFE0F WARNING \u26A0\uFE0F Multiple instances of Livelink WebXR being imported."):window.__LIVELINK__["@3dverse/livelink-webxr"]="0.1.12");
//# sourceMappingURL=index.cjs.map
